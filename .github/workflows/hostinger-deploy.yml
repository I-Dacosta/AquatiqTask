name: Deploy to Hostinger

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to deploy"
        required: false
        default: main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      HOSTINGER_HOST: ${{ secrets.HOSTINGER_HOST }}
      HOSTINGER_USER: ${{ secrets.HOSTINGER_USER }}
      REPO_DIR: ${{ vars.HOSTINGER_REPO_DIR || '/opt/TaskPriority' }}
      DEPLOY_BRANCH: ${{ inputs.branch || 'main' }}
      ENV_FILE: ${{ vars.HOSTINGER_ENV_FILE || '/opt/TaskPriority/.env.production' }}
      REPO_URL: git@github.com:${{ github.repository }}.git
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure deployment script is executable
        run: chmod +x infra/deploy/hostinger_deploy.sh

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HOSTINGER_SSH_KEY }}

      - name: Add Hostinger host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "$HOSTINGER_HOST" >> ~/.ssh/known_hosts

      - name: Upload deployment script to Hostinger
        run: scp infra/deploy/hostinger_deploy.sh "$HOSTINGER_USER@$HOSTINGER_HOST:/tmp/hostinger_deploy.sh"

      - name: Deploy stack on Hostinger
        run: |
          ssh "$HOSTINGER_USER@$HOSTINGER_HOST" '
            set -euo pipefail
            chmod +x /tmp/hostinger_deploy.sh
            REPO_URL="${{ env.REPO_URL }}" \
            REPO_DIR="${{ env.REPO_DIR }}" \
            DEPLOY_BRANCH="${{ env.DEPLOY_BRANCH }}" \
            ENV_FILE="${{ env.ENV_FILE }}" \
            /tmp/hostinger_deploy.sh
          '

      - name: Health check
        run: |
          echo "üè• Waiting 30s for services to stabilize..."
          sleep 30
          
          echo "Checking AI service health..."
          ssh "$HOSTINGER_USER@$HOSTINGER_HOST" \
            "docker exec taskpriority-ai-prioritization-1 curl -f http://localhost:8000/health || exit 1"
          
          echo "‚úÖ Deployment successful!"